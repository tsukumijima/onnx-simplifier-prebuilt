name: Build and Test

on:
  push:
    branches:
      - main
      - master
    tags:
      - v*
  pull_request:
  workflow_dispatch:

env:
  # This is used to skip tests that are too heavy for CI
  ONNXSIM_CI: 1
  # Package name - change this to switch between onnxsim and onnxsim-prebuilt
  ONNXSIM_PKG_NAME: onnxsim-prebuilt

jobs:
  build_wheels:
    env:
      CIBW_BUILD_FRONTEND: "pip; args: --no-build-isolation"
      CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
      CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
      CIBW_ENVIRONMENT_PASS_LINUX: ONNXSIM_CI ONNXSIM_PKG_NAME SCCACHE_GHA_ENABLED ACTIONS_RESULTS_URL ACTIONS_RUNTIME_TOKEN ACTIONS_CACHE_SERVICE_V2
      CIBW_BEFORE_BUILD: "python3 -m pip install --break-system-packages cmake ninja setuptools sccache"
      CIBW_TEST_REQUIRES: pytest flake8 onnxruntime onnxscript==0.2.3
      CIBW_BEFORE_TEST: pip install torch==2.6.0 torchvision==0.21.0 --index-url https://download.pytorch.org/whl/cpu/
      # Skip universal2 x86_64 tests (as PyTorch no longer supports them)
      CIBW_TEST_SKIP: "*_universal2:x86_64"
      CIBW_TEST_COMMAND: pytest -v {project}/tests/test_python_api.py && onnxsim -h
      # Skip 32-bit or musl or pypy builds
      CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_* pp*"
      SCCACHE_GHA_ENABLED: on
      ACTIONS_CACHE_SERVICE_V2: on
    name: Build wheel ${{ matrix.py_ver }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows AMD64
          - os: windows-2025
            archs: AMD64
            py_ver: cp310
          - os: windows-2025
            archs: AMD64
            py_ver: cp311
          - os: windows-2025
            archs: AMD64
            py_ver: cp312
          # macOS universal2
          - os: macos-15
            archs: universal2
            py_ver: cp310
          - os: macos-15
            archs: universal2
            py_ver: cp311
          - os: macos-15
            archs: universal2
            py_ver: cp312
          # Linux x86_64
          - os: ubuntu-24.04
            archs: x86_64
            py_ver: cp310
          - os: ubuntu-24.04
            archs: x86_64
            py_ver: cp311
          - os: ubuntu-24.04
            archs: x86_64
            py_ver: cp312
          # Linux aarch64
          - os: ubuntu-24.04-arm
            archs: aarch64
            py_ver: cp310
          - os: ubuntu-24.04-arm
            archs: aarch64
            py_ver: cp311
          - os: ubuntu-24.04-arm
            archs: aarch64
            py_ver: cp312
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - uses: mozilla-actions/sccache-action@v0.0.9
    - uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: amd64
      if: ${{ contains(matrix.os, 'windows') }}
    - name: Build onnxsim wheels
      uses: pypa/cibuildwheel@v3.3.1
      env:
        CIBW_BUILD: ${{ matrix.py_ver }}-*
        CIBW_ARCHS_WINDOWS: ${{ contains(matrix.os, 'windows') && matrix.archs || 'AMD64' }}
        CIBW_ARCHS_MACOS: ${{ contains(matrix.os, 'macos') && matrix.archs || 'x86_64' }}
        CIBW_ARCHS_LINUX: ${{ contains(matrix.os, 'ubuntu') && matrix.archs || 'x86_64' }}
        CIBW_ENVIRONMENT: CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF -DProtobuf_USE_STATIC_LIBS=ON -DCMAKE_POLICY_VERSION_MINIMUM=3.5" CMAKE_GENERATOR=Ninja CMAKE_CXX_COMPILER_LAUNCHER=sccache
        CIBW_ENVIRONMENT_WINDOWS: USE_MSVC_STATIC_RUNTIME=0 CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF -DProtobuf_USE_STATIC_LIBS=ON -DCMAKE_POLICY_VERSION_MINIMUM=3.5" CMAKE_GENERATOR=Ninja CMAKE_CXX_COMPILER_LAUNCHER=sccache ONNXSIM_PKG_NAME=${{ env.ONNXSIM_PKG_NAME }}
        CIBW_ENVIRONMENT_MACOS: MACOSX_DEPLOYMENT_TARGET=10.15 CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF -DProtobuf_USE_STATIC_LIBS=ON -DCMAKE_POLICY_VERSION_MINIMUM=3.5" CMAKE_GENERATOR=Ninja CMAKE_CXX_COMPILER_LAUNCHER=sccache ONNXSIM_PKG_NAME=${{ env.ONNXSIM_PKG_NAME }}
    - uses: actions/upload-artifact@v4
      with:
        name: python-dist-${{ matrix.os }}-${{ matrix.archs }}-${{ matrix.py_ver }}
        path: ./wheelhouse/*.whl

  # Test ABI3 wheel on Python 3.13+ (verifies cp312-abi3 wheel works on newer Python versions)
  test_abi3:
    name: Test ABI3 wheel on Python ${{ matrix.py_ver }} (${{ matrix.os }})
    needs: build_wheels
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Python 3.13
          - os: windows-2025
            archs: AMD64
            py_ver: "3.13"
          - os: macos-15
            archs: universal2
            py_ver: "3.13"
          - os: ubuntu-24.04
            archs: x86_64
            py_ver: "3.13"
          - os: ubuntu-24.04-arm
            archs: aarch64
            py_ver: "3.13"
          # Python 3.14
          - os: windows-2025
            archs: AMD64
            py_ver: "3.14"
          - os: macos-15
            archs: universal2
            py_ver: "3.14"
          - os: ubuntu-24.04
            archs: x86_64
            py_ver: "3.14"
          - os: ubuntu-24.04-arm
            archs: aarch64
            py_ver: "3.14"
    steps:
    - uses: actions/checkout@v4
    - name: Download cp312 ABI3 wheel
      uses: actions/download-artifact@v4
      with:
        name: python-dist-${{ matrix.os }}-${{ matrix.archs }}-cp312
        path: ./wheelhouse/
    - name: Set up Python ${{ matrix.py_ver }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.py_ver }}
        allow-prereleases: true
    - name: Test ABI3 wheel on Python ${{ matrix.py_ver }}
      run: |
        pip install pytest onnxruntime
        pip install ./wheelhouse/*.whl
        pytest -v tests/test_python_api.py
        onnxsim -h

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
      CMAKE_CXX_COMPILER_LAUNCHER: sccache
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - uses: mozilla-actions/sccache-action@v0.0.9

    - name: Update version
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        sed -i "s/0.0.0/${GITHUB_REF/refs\/tags\/v/}/" setup.py

    - name: Build sdist
      run: |
        export ONNXSIM_SDIST=ON
        pipx run build --sdist

    - name: Install and test sdist
      run: |
        # It's important to leave the project directory where a 'onnxsim' subdirectory exists
        cd dist
        python3 -m pip install onnxruntime ninja sccache
        # Install the sdist (package name uses underscore in filename)
        python3 -m pip install *.tar.gz
        python3 -c "import onnxsim; print(dir(onnxsim))"
        python3 -m pip uninstall -y $ONNXSIM_PKG_NAME

    - uses: actions/upload-artifact@v4
      with:
        name: python-dist-sdist
        path: dist/*.tar.gz

  upload_pypi:
    name: Upload to PyPI
    needs: [build_wheels, build_sdist, test_abi3]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        # unpacks python-dist artifact into dist/
        # if `name: python-dist` is omitted, the action will create extra parent dir
        pattern: python-dist-*
        path: dist
        merge-multiple: true
    - name: Publish distribution ðŸ“¦ to Test PyPI
      if: ${{ github.ref == 'refs/heads/master' }}
      uses: pypa/gh-action-pypi-publish@v1.12.4
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true
    - name: Publish distribution ðŸ“¦ to PyPI
      if: startsWith(github.ref, 'refs/tags/v')
      uses: pypa/gh-action-pypi-publish@v1.12.4
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
