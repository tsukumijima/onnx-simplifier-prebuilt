name: Build and Test

on:
  push:
    branches:
      - main
      - master
  pull_request:

env:
  ONNXSIM_CI: 1

jobs:
  build_wheels:
    env:
      CIBW_BUILD_FRONTEND: "pip; args: --no-build-isolation"
      CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
      CIBW_ENVIRONMENT_PASS_LINUX: ONNXSIM_CI
      CIBW_BEFORE_BUILD: "python3 -m pip install --break-system-packages cmake ninja setuptools"
      CIBW_TEST_REQUIRES: pytest flake8 onnxruntime onnxscript==0.2.3
      CIBW_BEFORE_TEST: pip install torch==2.6.0 torchvision==0.21.0 --index-url https://download.pytorch.org/whl/cpu/
      CIBW_TEST_COMMAND: pytest -v {project}/tests/test_python_api.py
      # Only build on Python 3 and skip 32-bit or musl builds
      CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_*"
      MACOSX_DEPLOYMENT_TARGET: "10.15"
    name: Build wheel ${{ matrix.name }}-${{ matrix.py_ver }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, windows-2025, macos-15]
        name: [onnxsim, onnx-simplifier]
        py_ver: [cp310, cp312, cp313]
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    - name: Build onnxsim wheels
      uses: pypa/cibuildwheel@v3.3.1
      env:
        CIBW_ENVIRONMENT: CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF" ONNXSIM_PKG_NAME=${{ matrix.name }} CMAKE_GENERATOR=Ninja
        CIBW_ENVIRONMENT_WINDOWS: USE_MSVC_STATIC_RUNTIME=0 CMAKE_ARGS="-DONNX_USE_PROTOBUF_SHARED_LIBS=OFF" ONNXSIM_PKG_NAME=${{ matrix.name }} CMAKE_BUILD_PARALLEL_LEVEL=4
        CIBW_BUILD: "${{ matrix.py_ver }}-*"
    - name: Check ABI3
      run: |
        pip install abi3audit
        abi3audit --strict -v --report ./wheelhouse/*.whl
      if: ${{ contains(fromJSON('["cp312", "cp313"]'), matrix.py_ver) }}
    - uses: actions/upload-artifact@v4
      with:
        name: python-dist-${{ matrix.os }}-${{ matrix.name }}-${{ matrix.py_ver }}
        path: ./wheelhouse/*.whl
      if: ${{ !contains(fromJSON('["cp313"]'), matrix.py_ver) }}

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Update version
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        sed -i "s/0.0.0/${GITHUB_REF/refs\/tags\/v/}/" setup.py

    - name: Build sdist
      run: |
        export ONNXSIM_SDIST=ON
        export ONNXSIM_PKG_NAME=onnxsim
        pipx run build --sdist
        export ONNXSIM_PKG_NAME=onnx-simplifier
        pipx run build --sdist

    - name: Install and test sdist
      run: |
        # It's important to leave the project directory where a 'onnxsim' subdirectory exists
        cd dist
        python3 -m pip install onnxruntime
        python3 -m pip install onnxsim-*.tar.gz
        python3 -c "import onnxsim; print(dir(onnxsim))"
        python3 -m pip uninstall -y onnxsim
        python3 -m pip install onnx_simplifier-*.tar.gz
        python3 -c "import onnxsim; print(dir(onnxsim))"
        python3 -m pip uninstall -y onnx-simplifier

    - uses: actions/upload-artifact@v4
      with:
        name: python-dist-sdist
        path: dist/*.tar.gz

  upload_pypi:
    name: Upload to PyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        # unpacks python-dist artifact into dist/
        # if `name: python-dist` is omitted, the action will create extra parent dir
        pattern: python-dist-*
        path: dist
        merge-multiple: true
    - name: Publish distribution ðŸ“¦ to Test PyPI
      if: ${{ github.ref == 'refs/heads/master' }}
      uses: pypa/gh-action-pypi-publish@v1.12.4
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/
        skip_existing: true
    - name: Publish distribution ðŸ“¦ to PyPI
      if: startsWith(github.ref, 'refs/tags/v')
      uses: pypa/gh-action-pypi-publish@v1.12.4
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}